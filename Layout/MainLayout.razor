@using GEMS.Models
@inherits LayoutComponentBase
@inject ProfilePictureService ProfilePictureService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<div class="page" @onclick="CloseDropdowns">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <!-- Top Bar -->
        <div class="top-row px-4 d-flex justify-content-between align-items-center">
            <!-- Search -->
            <input type="text" class="form-control" placeholder="Search..." style="max-width: 300px; margin-right: 15px;" />

            <!-- Icons + Profile -->
            <div class="d-flex align-items-center gap-3">
                <!-- Notification Icon -->
                @*<i class="fas fa-bell"></i>*@
                <div class="notification-container position-relative" @onclick:stopPropagation>
                    <button class="btn btn-link p-0 position-relative" @onclick="ToggleNotificationDropdown">
                        <i class="fas fa-bell fs-5"></i>
                        @if (unreadCount > 0)
                        {
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @unreadCount
                                <span class="visually-hidden">unread notifications</span>
                            </span>
                        }
                    </button>

                    @if (showNotificationDropdown)
                    {
                        <div class="notification-dropdown-menu shadow">
                            <div class="notification-header d-flex justify-content-between align-items-center p-3 border-bottom">
                                <h6 class="mb-0">Notifications (@unreadCount)</h6>
                                @if (unreadCount > 0)
                                {
                                    <button class="btn btn-sm btn-link p-0" @onclick="MarkAllAsRead">Mark all as read</button>
                                }
                            </div>

                            <div class="notification-list" style="max-height: 400px; overflow-y: auto;">
                                @if (notifications.Count == 0)
                                {
                                    <div class="p-3 text-center text-muted">No notifications</div>
                                }
                                else
                                {
                                    @foreach (var notification in notifications.OrderByDescending(n => n.CreatedAt))
                                    {
                                        <div class="notification-item p-3 border-bottom @(notification.IsRead ? "" : "bg-light")"
                                             @onclick="() => OnNotificationClick(notification)">
                                            <a href="/notifications/@notification.Id" class="text-decoration-none text-dark">
                                                <div class="d-flex justify-content-between">
                                                    <strong>@notification.Title</strong>
                                                    <small class="text-muted">@FormatTimeAgo(notification.CreatedAt)</small>
                                                </div>
                                                <div class="notification-message">@notification.Message</div>
                                                @if (!notification.IsRead)
                                                {
                                                    <span class="badge bg-primary">New</span>
                                                }
                                            </a>
                                        </div>
                                    }
                                }
                            </div>

                            <div class="notification-footer p-2 border-top text-center">
                                <a href="/notifications" class="text-decoration-none">View all notifications</a>
                            </div>
                        </div>
                    }
                </div>

                <!-- Theme Toggle -->
                <div class="theme-toggle" @onclick:stopPropagation>
                    <button class="btn btn-link p-0" style="margin-top: 0px; margin-left:0px;" @onclick="ToggleThemeDropdown">
                        <i class="@GetThemeIcon(currentTheme) fs-5"></i>
                        <span class="theme-text">@GetThemeLabel(currentTheme)</span>
                    </button>

                    @if (showThemeDropdown)
                    {
                        <div class="theme-dropdown-menu shadow">
                            <div class="theme-dropdown-item" @onclick="@(() => ChangeTheme("light"))">
                                <i class="fas fa-sun me-2 text-warning"></i> Light
                            </div>
                            <div class="theme-dropdown-item" @onclick="@(() => ChangeTheme("dark"))">
                                <i class="fas fa-moon me-2 text-info"></i> Dark
                            </div>
                            <div class="theme-dropdown-item" @onclick="@(() => ChangeTheme("auto"))">
                                <i class="fas fa-adjust me-2 text-secondary"></i> Auto
                            </div>
                        </div>
                    }
                </div>

                <!-- Profile -->
                <!-- Replace your entire profile section with this: -->
                <!-- Profile Section -->
                <div class="profile-container position-relative">
                    <div class="d-flex align-items-center gap-2" @onclick="ToggleProfileDropdown" @onclick:stopPropagation>
                        <img src="@(currentUser?.ProfilePictureUrl ?? ProfilePictureService.ProfilePictureUrl)"
                             class="profile-picture rounded-circle" />
                        <span>
                            @(currentUser?.Fullname ?? userName)
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </div>

                    <div class="@GetDropdownClass()" @onclick:stopPropagation>
                        <div class="dropdown-header px-3 py-2">
                            <div class="fw-bold">@(currentUser?.Fullname)</div>
                            <div class="small text-muted">@(currentUser?.Email)</div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/user-profile/@userId">
                            <i class="fas fa-user-edit me-2"></i>Edit Profile
                        </a>
                        <a class="dropdown-item" href="/changePassword">
                            <i class="fas fa-key me-2"></i>Change Password
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" @onclick="Logout" style="cursor: pointer;">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<style>
    /* Profile Styles */
    .profile-container {
        position: relative;
    }

    .profile-dropdown-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 5px);
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 0.5rem 0;
        z-index: 1050;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        opacity: 0;
        transform: translateY(-10px);
        visibility: hidden;
        transition: all 0.3s ease;
        min-width: 200px;
    }

        .profile-dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .profile-picture {
            width: 38px;
        }

    .dropdown-item {
        padding: 0.5rem 1.5rem;
        color: var(--bs-body-color);
        text-decoration: none;
        display: flex;
        align-items: center;
        white-space: nowrap;
    }

        .dropdown-item:hover {
            background-color: var(--bs-tertiary-bg);
        }

    /* Notification Styles */
    .notification-container {
        position: relative;
        margin-right: 15px;
    }

    .notification-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        width: 350px;
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        z-index: 1050;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .notification-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .notification-item:hover {
            background-color: var(--bs-tertiary-bg) !important;
        }

    .notification-message {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 4px;
    }

    .notification-footer a {
        color: var(--bs-link-color);
    }

    /* Theme Toggle Styles */
    .theme-toggle {
        position: relative;
        display: inline-block;
    }

        .theme-toggle button {
            background: none;
            border: none;
            color: var(--bs-body-color);
            display: flex;
            align-items: center;
            padding: 0.5rem;
        }

    .theme-text {
        margin-left: 0.5rem;
        display: none;
    }

    @@media (min-width: 992px) {
        .theme-text {
            display: inline;
        }
    }

    .theme-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background-color: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 0.5rem 0;
        z-index: 1000;
        min-width: 120px;
    }

    .theme-dropdown-item {
        padding: 0.25rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

        .theme-dropdown-item:hover {
            background-color: var(--bs-tertiary-bg);
        }

    /* Theme Variables */
    :root[data-bs-theme="dark"] {
        --bs-body-bg: #121212;
        --bs-body-color: #ffffff;
        --bs-border-color: #333333;
        --bs-tertiary-bg: #1e1e1e;
    }

    :root[data-bs-theme="light"] {
        --bs-body-bg: #ffffff;
        --bs-body-color: #000000;
        --bs-border-color: #dee2e6;
        --bs-tertiary-bg: #f8f9fa;
    }
</style>

@code {
    private int userId;
    private string? userName;
    private UserModel? currentUser;
    private bool isProfileDropdownOpen = false;
    private bool showNotificationDropdown = false;
    private List<Notification> notifications = new();
    private int unreadCount = 0;
    private bool showThemeDropdown = false;
    private string currentTheme = "light";
    private string GetDropdownClass()
    {
        return isProfileDropdownOpen
            ? "profile-dropdown-menu show"
            : "profile-dropdown-menu";
    }

    protected override async Task OnInitializedAsync()
    {
        
        var userIdString = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "UserId");
        if (int.TryParse(userIdString, out var parsedId))
        {
            userId = parsedId;
        }

        userName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userEmail");
        currentTheme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "theme") ?? "auto";
        await ApplyTheme(currentTheme);
        ProfilePictureService.OnProfilePictureChanged += StateHasChanged;

        // Load notifications when component initializes
        await LoadNotifications();
    }

    private string FormatTimeAgo(DateTime date)
    {
        var timeSpan = DateTime.Now - date;

        if (timeSpan <= TimeSpan.FromSeconds(60))
        {
            return $"{timeSpan.Seconds} seconds ago";
        }
        else if (timeSpan <= TimeSpan.FromMinutes(60))
        {
            return $"{timeSpan.Minutes} minutes ago";
        }
        else if (timeSpan <= TimeSpan.FromHours(24))
        {
            return $"{timeSpan.Hours} hours ago";
        }
        else if (timeSpan <= TimeSpan.FromDays(30))
        {
            return $"{timeSpan.Days} days ago";
        }

        return date.ToString("MMM dd, yyyy");
    }

    private async Task LoadNotifications()
    {
        var email = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userEmail");
        var role = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");
        notifications = await NotificationService.GetNotificationsForUserAsync(email, role);
        unreadCount = await NotificationService.GetUnreadNotificationCountAsync(email, role);
        StateHasChanged();
    }

    private void ToggleNotificationDropdown()
    {
        showNotificationDropdown = !showNotificationDropdown;
        isProfileDropdownOpen = false;
        showThemeDropdown = false;

        if (showNotificationDropdown)
        {
            LoadNotifications();
        }
    }

    private async Task OnNotificationClick(Notification notification)
    {
        if (!notification.IsRead)
        {
            await NotificationService.MarkNotificationAsRead(notification.Id);
            unreadCount--;
        }

        Navigation.NavigateTo(notification.ActionLink ?? "/");
        showNotificationDropdown = false;
    }

    private async Task MarkAllAsRead()
    {
        await NotificationService.MarkAllNotificationsAsRead();
        unreadCount = 0;
        await LoadNotifications();
    }


    private void ToggleProfileDropdown()
    {
        isProfileDropdownOpen = !isProfileDropdownOpen;
        showThemeDropdown = false;
    }

    private void ToggleThemeDropdown()
    {
        showThemeDropdown = !showThemeDropdown;
        isProfileDropdownOpen = false;
    }

    private void CloseDropdowns()
    {
        showThemeDropdown = false;
        isProfileDropdownOpen = false;
    }

    private async Task ChangeTheme(string theme)
    {
        currentTheme = theme;
        showThemeDropdown = false;
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "theme", theme);
        await ApplyTheme(theme);
        StateHasChanged();
    }

    private async Task ApplyTheme(string theme)
    {
        try
        {
            if (theme == "auto")
            {
                var prefersDark = await JSRuntime.InvokeAsync<bool>("eval",
                    "(window.matchMedia('(prefers-color-scheme: dark)').matches)");
                await JSRuntime.InvokeVoidAsync("document.documentElement.setAttribute",
                    "data-bs-theme", prefersDark ? "dark" : "light");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("document.documentElement.setAttribute",
                    "data-bs-theme", theme);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying theme: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("document.documentElement.setAttribute",
                "data-bs-theme", "light");
        }
    }

    private string GetThemeIcon(string theme)
    {
        return theme switch
        {
            "dark" => "fas fa-moon",
            "light" => "fas fa-sun",
            "auto" => "fas fa-adjust",
            _ => "fas fa-sun",
        };
    }

    private string GetThemeLabel(string theme)
    {
        return theme switch
        {
            "dark" => "Dark",
            "light" => "Light",
            "auto" => "Auto",
            _ => "Light",
        };
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "userRole");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "userEmail");
        Navigation.NavigateTo("/");
    }
}